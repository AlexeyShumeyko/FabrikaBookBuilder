name: Build and Release

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

env:
  DOTNET_VERSION: '8.0.x'
  PROJECT_NAME: 'PhotoBookRenamer'
  SOLUTION_FILE: 'PhotoBookRenamer.sln'

jobs:
  build:
    runs-on: windows-latest
    permissions:
      contents: write
      pull-requests: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        
    - name: Get version from project
      id: get_version
      run: |
        $version = (Select-Xml -Path "PhotoBookRenamer.csproj" -XPath "//Version").Node.InnerText
        echo "VERSION=$version" >> $env:GITHUB_ENV
        echo "VERSION=$version" >> $env:GITHUB_OUTPUT
        
    - name: Restore dependencies
      run: dotnet restore ${{ env.SOLUTION_FILE }}
      
    - name: Build project
      run: dotnet build ${{ env.SOLUTION_FILE }} --configuration Release --no-restore /p:Version=${{ env.VERSION }}
      
    - name: Publish application
      run: |
        dotnet publish ${{ env.SOLUTION_FILE }} `
          --configuration Release `
          --output ./publish `
          --self-contained true `
          --runtime win-x64 `
          /p:PublishSingleFile=true `
          /p:IncludeNativeLibrariesForSelfExtract=true `
          /p:Version=${{ env.VERSION }}
          
    - name: Install Inno Setup
      uses: ammaraskar/setup-inno-setup@v1.1.0
      with:
        version: '6.2.2'
        
    - name: Create installer script (Inno Setup)
      run: |
        $issScript = @"
        [Setup]
        AppId={{8B8E5F3C-5F3C-4B8E-9F3C-5F3C4B8E9F3C}
        AppName=Fabrika BookBuilder Studio
        AppVersion=${{ env.VERSION }}
        AppPublisher=Fabrika
        AppPublisherURL=https://github.com/AlexeyShumeyko/FabrikaBookBuilder
        DefaultDirName={autopf}\Fabrika BookBuilder Studio
        DefaultGroupName=Fabrika BookBuilder Studio
        OutputDir=.
        OutputBaseFilename=BookBuilder-Studio-Setup-${{ env.VERSION }}
        Compression=lzma2
        SolidCompression=yes
        SetupIconFile=publish\icon.ico
        UninstallDisplayIcon={app}\PhotoBookRenamer.exe
        PrivilegesRequired=admin
        LicenseFile=
        InfoBeforeFile=
        InfoAfterFile=
        
        [Languages]
        Name: "russian"; MessagesFile: "compiler:Languages\Russian.isl"
        
        [Tasks]
        Name: "desktopicon"; Description: "{cm:CreateDesktopIcon}"; GroupDescription: "{cm:AdditionalIcons}"; Flags: unchecked
        Name: "quicklaunchicon"; Description: "{cm:CreateQuickLaunchIcon}"; GroupDescription: "{cm:AdditionalIcons}"; Flags: unchecked; OnlyBelowVersion: 6.1
        
        [Files]
        Source: "publish\*"; DestDir: "{app}"; Flags: ignoreversion recursesubdirs createallsubdirs
        
        [Icons]
        Name: "{group}\Fabrika BookBuilder Studio"; Filename: "{app}\PhotoBookRenamer.exe"; IconFilename: "{app}\icon.ico"
        Name: "{group}\{cm:UninstallProgram,Fabrika BookBuilder Studio}"; Filename: "{uninstallexe}"
        Name: "{autodesktop}\Fabrika BookBuilder Studio"; Filename: "{app}\PhotoBookRenamer.exe"; IconFilename: "{app}\icon.ico"; Tasks: desktopicon
        Name: "{userappdata}\Microsoft\Internet Explorer\Quick Launch\Fabrika BookBuilder Studio"; Filename: "{app}\PhotoBookRenamer.exe"; IconFilename: "{app}\icon.ico"; Tasks: quicklaunchicon
        
        [Run]
        Filename: "{app}\PhotoBookRenamer.exe"; Description: "{cm:LaunchProgram,Fabrika BookBuilder Studio}"; Flags: nowait postinstall skipifsilent
        "@
        $issScript | Out-File -FilePath ./installer.iss -Encoding UTF8 -NoNewline
        
    - name: Build installer with Inno Setup
      run: |
        $innoPath = "${env:ProgramFiles(x86)}\Inno Setup 6\ISCC.exe"
        if (Test-Path $innoPath) {
          & $innoPath installer.iss
        } else {
          $innoPath = "${env:ProgramFiles}\Inno Setup 6\ISCC.exe"
          if (Test-Path $innoPath) {
            & $innoPath installer.iss
          } else {
            Write-Error "Inno Setup not found"
            exit 1
          }
        }
        
    - name: Create release notes
      id: release_notes
      run: |
        $notes = "## Что нового в версии ${{ env.VERSION }}`n`n"
        $notes += "Автоматическая сборка от $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')`n`n"
        $notes += "### Изменения:`n"
        $notes += "- Обновления из последнего коммита`n"
        $notes | Out-File -FilePath ./release-notes.md -Encoding UTF8
        
    - name: Find installer file
      id: find_installer
      run: |
        $installerExe = Get-ChildItem -Path . -Filter "BookBuilder-Studio-Setup-${{ env.VERSION }}.exe" -ErrorAction SilentlyContinue
        if ($installerExe) {
          echo "INSTALLER_FILE=$($installerExe.Name)" >> $env:GITHUB_ENV
          echo "INSTALLER_FILE=$($installerExe.Name)" >> $env:GITHUB_OUTPUT
        } else {
          Write-Error "Installer .exe file not found"
          exit 1
        }
        
    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: v${{ env.VERSION }}
        name: Release v${{ env.VERSION }}
        body_path: ./release-notes.md
        files: |
          ${{ env.INSTALLER_FILE }}
        draft: false
        prerelease: false
        generate_release_notes: true

