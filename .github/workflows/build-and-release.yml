name: Build and Release

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

env:
  DOTNET_VERSION: '8.0.x'
  PROJECT_NAME: 'PhotoBookRenamer'
  SOLUTION_FILE: 'PhotoBookRenamer.sln'

jobs:
  build:
    runs-on: windows-latest
    permissions:
      contents: write
      pull-requests: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        
    - name: Get version from project
      id: get_version
      run: |
        $version = (Select-Xml -Path "PhotoBookRenamer.csproj" -XPath "//Version").Node.InnerText
        echo "VERSION=$version" >> $env:GITHUB_ENV
        echo "VERSION=$version" >> $env:GITHUB_OUTPUT
        
    - name: Restore dependencies
      run: dotnet restore ${{ env.SOLUTION_FILE }}
      
    - name: Build project
      run: dotnet build ${{ env.SOLUTION_FILE }} --configuration Release --no-restore /p:Version=${{ env.VERSION }}
      
    - name: Publish application
      run: |
        dotnet publish ${{ env.SOLUTION_FILE }} `
          --configuration Release `
          --output ./publish `
          --self-contained true `
          --runtime win-x64 `
          /p:PublishSingleFile=true `
          /p:IncludeNativeLibrariesForSelfExtract=true `
          /p:Version=${{ env.VERSION }}
          
    - name: Install Inno Setup
      run: |
        $innoUrl = "https://files.jrsoftware.org/is/6/innosetup-6.2.2.exe"
        $innoPath = "$env:TEMP\innosetup.exe"
        Write-Host "Downloading Inno Setup..."
        Invoke-WebRequest -Uri $innoUrl -OutFile $innoPath -UseBasicParsing
        Write-Host "Installing Inno Setup silently..."
        Start-Process -FilePath $innoPath -ArgumentList "/SILENT /SUPPRESSMSGBOXES /NORESTART" -Wait
        Start-Sleep -Seconds 5
        
    - name: Create installer script (Inno Setup)
      run: |
        $issScript = @"
        [Setup]
        AppId={{8B8E5F3C-5F3C-4B8E-9F3C-5F3C4B8E9F3C}
        AppName=Fabrika BookBuilder Studio
        AppVersion=${{ env.VERSION }}
        AppPublisher=Fabrika
        AppPublisherURL=https://github.com/AlexeyShumeyko/FabrikaBookBuilder
        DefaultDirName={autopf}\Fabrika BookBuilder Studio
        DefaultGroupName=Fabrika BookBuilder Studio
        OutputDir=.
        OutputBaseFilename=BookBuilder-Studio-Setup-${{ env.VERSION }}
        Compression=lzma2
        SolidCompression=yes
        SetupIconFile=publish\icon.ico
        UninstallDisplayIcon={app}\PhotoBookRenamer.exe
        PrivilegesRequired=admin
        LicenseFile=
        InfoBeforeFile=
        InfoAfterFile=
        
        [Languages]
        Name: "russian"; MessagesFile: "compiler:Languages\Russian.isl"
        
        [Tasks]
        Name: "desktopicon"; Description: "{cm:CreateDesktopIcon}"; GroupDescription: "{cm:AdditionalIcons}"; Flags: unchecked
        Name: "quicklaunchicon"; Description: "{cm:CreateQuickLaunchIcon}"; GroupDescription: "{cm:AdditionalIcons}"; Flags: unchecked; OnlyBelowVersion: 6.1
        
        [Files]
        Source: "publish\*"; DestDir: "{app}"; Flags: ignoreversion recursesubdirs createallsubdirs
        
        [Icons]
        Name: "{group}\Fabrika BookBuilder Studio"; Filename: "{app}\PhotoBookRenamer.exe"; IconFilename: "{app}\icon.ico"
        Name: "{group}\{cm:UninstallProgram,Fabrika BookBuilder Studio}"; Filename: "{uninstallexe}"
        Name: "{autodesktop}\Fabrika BookBuilder Studio"; Filename: "{app}\PhotoBookRenamer.exe"; IconFilename: "{app}\icon.ico"; Tasks: desktopicon
        Name: "{userappdata}\Microsoft\Internet Explorer\Quick Launch\Fabrika BookBuilder Studio"; Filename: "{app}\PhotoBookRenamer.exe"; IconFilename: "{app}\icon.ico"; Tasks: quicklaunchicon
        
        [Run]
        Filename: "{app}\PhotoBookRenamer.exe"; Description: "{cm:LaunchProgram,Fabrika BookBuilder Studio}"; Flags: nowait postinstall skipifsilent
        "@
        $issScript | Out-File -FilePath ./installer.iss -Encoding UTF8
        
    - name: Build installer with Inno Setup
      run: |
        # Ищем Inno Setup в стандартных местах установки
        $innoPaths = @(
          "${env:ProgramFiles(x86)}\Inno Setup 6\ISCC.exe",
          "${env:ProgramFiles}\Inno Setup 6\ISCC.exe"
        )
        
        $innoPath = $null
        foreach ($path in $innoPaths) {
          if (Test-Path $path) {
            $innoPath = $path
            break
          }
        }
        
        if ($null -eq $innoPath) {
          # Пробуем найти через PATH
          $found = Get-Command ISCC.exe -ErrorAction SilentlyContinue
          if ($found) {
            $innoPath = $found.Source
          }
        }
        
        if ($null -eq $innoPath) {
          Write-Error "Inno Setup not found. Tried paths: $($innoPaths -join ', ')"
          Get-ChildItem "${env:ProgramFiles(x86)}" -Filter "*Inno*" -ErrorAction SilentlyContinue | ForEach-Object { Write-Host "Found: $($_.FullName)" }
          Get-ChildItem "${env:ProgramFiles}" -Filter "*Inno*" -ErrorAction SilentlyContinue | ForEach-Object { Write-Host "Found: $($_.FullName)" }
          exit 1
        }
        
        Write-Host "Using Inno Setup at: $innoPath"
        & $innoPath installer.iss
        
    - name: Create release notes
      id: release_notes
      run: |
        $notes = "## Что нового в версии ${{ env.VERSION }}`n`n"
        $notes += "Автоматическая сборка от $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')`n`n"
        $notes += "### Изменения:`n"
        $notes += "- Обновления из последнего коммита`n"
        $notes | Out-File -FilePath ./release-notes.md -Encoding UTF8
        
    - name: Find installer file and create ZIP
      id: find_installer
      run: |
        $installerExe = Get-ChildItem -Path . -Filter "BookBuilder-Studio-Setup-${{ env.VERSION }}.exe" -ErrorAction SilentlyContinue
        if (-not $installerExe) {
          Write-Error "Installer .exe file not found"
          exit 1
        }
        
        # Создаём ZIP архив с установщиком
        $zipFileName = "BookBuilder-Studio-Setup-${{ env.VERSION }}.zip"
        Compress-Archive -Path $installerExe.FullName -DestinationPath $zipFileName -Force
        
        echo "INSTALLER_EXE=$($installerExe.Name)" >> $env:GITHUB_ENV
        echo "INSTALLER_EXE=$($installerExe.Name)" >> $env:GITHUB_OUTPUT
        echo "INSTALLER_ZIP=$zipFileName" >> $env:GITHUB_ENV
        echo "INSTALLER_ZIP=$zipFileName" >> $env:GITHUB_OUTPUT
        
    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: v${{ env.VERSION }}
        name: Release v${{ env.VERSION }}
        body_path: ./release-notes.md
        files: |
          ${{ env.INSTALLER_ZIP }}
        draft: false
        prerelease: false
        generate_release_notes: true
        
    - name: Update previous releases with new installer
      run: |
        $token = "${{ secrets.GITHUB_TOKEN }}"
        $owner = "AlexeyShumeyko"
        $repo = "FabrikaBookBuilder"
        $newInstallerZip = "${{ env.INSTALLER_ZIP }}"
        $newInstallerExe = "${{ env.INSTALLER_EXE }}"
        $currentVersion = "${{ env.VERSION }}"
        
        # Получаем все релизы через GitHub API
        $headers = @{
          "Authorization" = "Bearer $token"
          "Accept" = "application/vnd.github+json"
          "X-GitHub-Api-Version" = "2022-11-28"
        }
        
        Write-Host "Fetching all releases..."
        $releases = Invoke-RestMethod -Uri "https://api.github.com/repos/$owner/$repo/releases" -Headers $headers -Method Get
        
        # Обновляем каждый предыдущий релиз
        foreach ($release in $releases) {
          if ($release.tag_name -eq "v$currentVersion") {
            Write-Host "Skipping current release: $($release.tag_name)"
            continue
          }
          
          Write-Host "Updating release: $($release.tag_name)"
          
          # Удаляем старые установщики из релиза
          foreach ($asset in $release.assets) {
            if ($asset.name -like "BookBuilder-Studio-Setup-*.zip" -or $asset.name -like "BookBuilder-Studio-Setup-*.exe") {
              Write-Host "Deleting old asset: $($asset.name)"
              Invoke-RestMethod -Uri $asset.url -Headers $headers -Method Delete
            }
          }
          
          # Загружаем новый установщик в этот релиз
          Write-Host "Uploading new installer to release: $($release.tag_name)"
          $uploadUrl = $release.upload_url -replace '\{.*\}', "?name=$newInstallerZip"
          
          try {
            $fileContent = [System.IO.File]::ReadAllBytes($newInstallerZip)
            $uploadHeaders = @{
              "Authorization" = "Bearer $token"
              "Accept" = "application/vnd.github+json"
              "X-GitHub-Api-Version" = "2022-11-28"
              "Content-Type" = "application/zip"
            }
            
            # Загружаем файл напрямую
            Invoke-RestMethod -Uri $uploadUrl -Headers $uploadHeaders -Method Post -Body $fileContent
            Write-Host "Successfully updated release: $($release.tag_name)"
          } catch {
            Write-Host "Error updating release $($release.tag_name): $($_.Exception.Message)"
            # Не прерываем выполнение, если не удалось обновить старый релиз
          }
        }

